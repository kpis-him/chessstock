{%extends "layout.html"%}

{%block main%}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
    crossorigin="anonymous"></script>

<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
    integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"
    integrity="sha512-xRllwz2gdZciIB+AkEbeq+gVhX8VB8XsfqeFbUh+SzHlN96dEduwtTuVuc2u9EROlmW9+yhRlxjif66ORpsgVA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/9.0.0/stockfish.js"></script>
<script>
    $("button").click(function () {
        $("div").animate({ down: '250px' });
    })
</script>
<div class="container">
    <div class="row">
        <h1>You are a/an {{winner}} player!!</h1>

        <p>{{response | safe}}</p>
        <h2>Do you want to play your new bot?</h2>
        <p>{{name}}'s bot</p>
        <h5>{{elo}}</h5>

        <div id="board" style="width: 400px">
        </div>
        <script>
            var stockfish = new Worker('static/stockfish1/stockfish.js');
            var game = new Chess();
            const userColor = 'w';
            const engineColor = 'b';
            var engineThinking = false;
            var moveList = [];
            var hintRequested = false;
            const persona = "{{winner}}".toLowerCase();

            var board = Chessboard('board', {
                position: 'start',
                pieceTheme: '/static/img/chesspieces/wikipedia/{piece}.png',
                draggable: true,
                onDragStart: function (source, piece) {
                    if (game.game_over()) {
                        console.log("Game over!");
                        return false;
                    }
                    // Only allow user to move their pieces
                    if ((game.turn() === 'w' && piece.startsWith('b')) ||
                        (game.turn() === 'b' && piece.startsWith('w'))) {
                        return false;
                    }
                    // Prevent move while engine thinking
                    if (engineThinking) return false;
                },
                onDrop: function (source, target) {
                    if (engineThinking) return 'snapback';

                    // Try to make move on the game
                    const move = game.move({
                        from: source,
                        to: target,
                        promotion: 'q' // always promote to queen for simplicity
                    });

                    if (move === null) return 'snapback';

                    console.log("User move:", move.san);

                    board.position(game.fen());

                    // If now it's engine's turn, tell engine to think
                    if (game.turn() === engineColor) {
                        engineThinking = true;
                        stockfish.postMessage('stop');
                        stockfish.postMessage('position fen ' + game.fen());

                        // Determine depth based on elo variable
                        const elo = '{{elo|int}}';
                        let depth = Math.floor(elo / 210);
                        depth = Math.min(Math.max(depth, 5), 10);
                        stockfish.postMessage(`go depth ${depth}`);
                    }
                },
                onSnapEnd: function () {
                    board.position(game.fen());
                }
            });

            // Disable scrolling on touch drag for the board
            document.getElementById('board').addEventListener('touchmove', function (e) {
                e.preventDefault();
            }, { passive: false });

            stockfish.postMessage("setoption name MultiPV value 3");

            stockfish.addEventListener('message', function (e) {
                const line = e.data;

                if (line.includes(" pv ")) {
                    const parts = line.split(" pv ");
                    const move = parts[1].split(" ")[0];
                    if (!moveList.includes(move)) {
                        moveList.push(move);
                    }
                }

                if (line.startsWith('bestmove')) {
                    if (hintRequested) {
                        engineThinking = false;
                        hintRequested = false;
                        const bestMove = line.split(' ')[1];
                        const fromSquare = bestMove.slice(0, 2);
                        const piece = game.get(fromSquare); // Get piece on 'from' square
                        let pieceName = '';
                        if (piece) {
                            const names = {
                                p: 'Pawn',
                                n: 'Knight',
                                b: 'Bishop',
                                r: 'Rook',
                                q: 'Queen',
                                k: 'King'
                            };
                            pieceName = names[piece.type];
                        }
                        alert(`Hint: Move your ${pieceName} from ${bestMove.slice(0, 2)} to ${bestMove.slice(2, 4)}`);
                        document.getElementById('hint').disabled = false;
                    } else {
                        if (game.turn() !== engineColor) {
                            console.log("Ignoring Stockfish move: not engine's turn");
                            return;
                        }

                        const bestMove = line.split(' ')[1];
                        console.log("Stockfish bestmove:", bestMove);

                        const moveObj = game.move({
                            from: bestMove.slice(0, 2),
                            to: bestMove.slice(2, 4),
                            promotion: bestMove.length > 4 ? bestMove[4] : 'q'
                        });

                        if (moveObj === null) {
                            console.error("Illegal move from Stockfish:", bestMove);
                            engineThinking = false;
                            return;
                        }

                        console.log("Engine move executed:", moveObj.san);

                        board.position(game.fen());
                        moveList = [];
                        engineThinking = false;
                    }
                }
            });

            function giveHint() {
                if (engineThinking) return;
                engineThinking = true;
                hintRequested = true;
                document.getElementById('hint').disabled = true;

                stockfish.postMessage('stop');

                setTimeout(() => {
                    stockfish.postMessage('position fen ' + game.fen());
                    stockfish.postMessage('go movetime 1000');
                }, 100);
            }
        </script>
        <p>You</p>
    </div>
    <div class="col">
        <button id="hint" onclick="giveHint()">Hint?</button>
    </div>
</div>
{%endblock%}