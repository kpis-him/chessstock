{%extends "layout.html"%}

{%block main%}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2"
    crossorigin="anonymous"></script>

<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"
    integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"
    integrity="sha512-xRllwz2gdZciIB+AkEbeq+gVhX8VB8XsfqeFbUh+SzHlN96dEduwtTuVuc2u9EROlmW9+yhRlxjif66ORpsgVA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/9.0.0/stockfish.js"></script>
<script>
    $("button").click(function () {
        $("div").animate({ down: '250px' });
    })
</script>
<div class="container">
    <div class="row">
        <h1>You are a/an {{winner}} player!!</h1>

        <p>{{response | safe}}</p>
        <h2>Do you want to play your new bot?</h2>
        <p>{{name}}'s bot</p>
        <h5>{{elo}}</h5>

        <div id="board" style="width: 400px">
            <script>
                var wasmSupported = typeof WebAssembly === 'object' && WebAssembly.validate(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00));
                var stockfish = new Worker('static/stockfish1/stockfish.js');
                var game = new Chess()

                var board = Chessboard('board', {
                    position: 'start',
                    pieceTheme: '/static/img/chesspieces/wikipedia/{piece}.png',
                    draggable: true,
                    onDragStart: function (source, piece) {
                        if (game.game_over()) {
                            update_table()
                            console.log("GGs")
                            var log = console.log("PNG", game.png())
                            return false, log;
                        }
                        if ((game.turn() === 'w' && piece.startsWith('b')) ||
                            (game.turn() === 'b' && piece.startsWith('w'))) {
                            return false;
                        }
                    },
                    onDrop: function (source, target) {
                        const move = game.move({
                            from: source,
                            to: target,
                            promotion: 'q'
                        });
                        if (move === null) return 'snapback';
                        //console.log("Move:", move.san);
                        var table = console.log("PGN", game.pgn());
                        stockfish.postMessage('position fen ' + game.fen());
                        stockfish.postMessage('go depth',"{{elo}}"/90);
                        //stockfish.postMessage('go movetime 500ms');
                    },
                    onSnapEnd: function () {
                        board.position(game.fen());
                    },
                })
                document.getElementById('board').addEventListener('touchmove', function (e) {
                    e.preventDefault(); // Prevent the default scrolling behavior
                }, { passive: false });



                let moveList = [];
                const persona = "{{winner}}".toLowerCase();

                stockfish.postMessage("setoption name MultiPV value 3");

                stockfish.addEventListener('message', function (e) {
                    const line = e.data;

                    if (line.includes(" pv ")) {
                        const parts = line.split(" pv ");
                        const move = parts[1].split(" ")[0];
                        if (!moveList.includes(move)) {
                            moveList.push(move);
                        }
                    }

                    if (line.startsWith('bestmove')) {
                        const selectedMove = chooseMoveByPersona(moveList, persona);
                        if (!selectedMove) return;

                        game.move({
                            from: selectedMove.slice(0, 2),
                            to: selectedMove.slice(2, 4),
                            promotion: 'q'
                        });
                        board.position(game.fen());
                        moveList = []; // reset for next turn
                    }
                });

                function chooseMoveByPersona(moves, type) {
                    if (moves.length === 0) return null;

                    switch (type) {
                        case "calculator":
                            return moves[0]; // best move
                        case "tactical":
                            return moves[1] || moves[0]; // 2nd best
                        case "random":
                            return moves[Math.floor(Math.random() * moves.length)];
                        case "aggressive":
                            // Try to pick a capturing move
                            const captures = moves.filter(m => m.includes("x"));
                            return captures[0] || moves[0];
                        default:
                            return moves[0];
                    }
                }


            </script>
            <p>You</p>
        </div>
        <div class="col">

        </div>
    </div>
</div>
{%endblock%}